# B-0205 — Gate G1 real execution path (Edge↔Core↔Kafka↔Ledger)

## Goal
Replace Edge local accepted-only order handling with a real execution path where Trading Core is the source of truth, trades are durably committed, and settlement is driven by TradeExecuted events.

## Scope
- Edge `/v1/orders` must call Trading Core gRPC `PlaceOrder` (no in-memory accepted fallback).
- Trading Core runs as tonic gRPC server and handles `PlaceOrder`.
- Trading Core minimal matching engine supports price-crossing execution for `BTC-KRW`.
- On match:
  - order status transitions: `ACCEPTED -> PARTIALLY_FILLED -> FILLED`
  - emit `TradeExecuted` with `{trade_id, symbol, price, qty, taker_order_id, maker_order_id, seq, ts}`
- Commit line rule:
  - `TradeExecuted` publish is allowed only after WAL durable append (`fsync`)
  - if no prior WAL path exists, use simple per-symbol WAL file
- After durable commit:
  - publish `TradeExecuted` to Kafka/Redpanda topic
  - Edge WS trade stream should consume from Kafka when available
- Ledger consumes `TradeExecuted` idempotently (`trade_id` unique effect).
- Add `scripts/smoke_match.sh`:
  1. start infra (`docker compose`)
  2. start core + edge + ledger
  3. submit BUY then SELL crossing orders
  4. verify `TradeExecuted` produced (Kafka and/or ledger lookup)
  5. exit `0` on success

## Acceptance Criteria
- `POST /v1/orders` BUY then SELL (same symbol, crossing price) results in at least one `FILLED` order.
- At least one matching `TradeExecuted` is produced and observable.
- Edge order route no longer treats local in-memory map as source of truth.
- Ledger applies trade idempotently.

## Tests
- Unit: Trading Core matching/status transitions.
- Unit: Edge order API + Kafka trade ingestion path.
- Smoke: `scripts/smoke_match.sh`.

## Observability
- Logs around:
  - core WAL append + outbox publish
  - edge kafka consume/apply
  - ledger settlement success/duplicate

## Rollback / Recovery
- If Kafka publish path is unstable, keep WAL/outbox durable and replay pending events.
- If ledger lags, keep trading path running with reconciliation gap monitoring and throttle policy.

## Dependencies
- B-0101, B-0102, B-0110, B-0114, B-0201, B-0302
