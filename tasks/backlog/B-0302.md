# B-0302 — Settlement consumer v1 (TradeExecuted → postings, idempotent)

## Goal
Consume TradeExecuted events and append ledger entries idempotently.

## Scope
- Kafka consumer group
- Idempotency: dedup by trade_id
- Postings: buyer/seller + fee accounts
- Transactional write per trade

## Acceptance Criteria
- Duplicate trade events do not duplicate ledger entries
- Settlement lag tracked; retries safe
- Failure routes to DLQ with reason

## Tests
- Integration tests with Redpanda/Postgres
- Duplicate delivery test
- Kill during tx test and recovery

## Observability
- Metrics: settlement_lag_ms, settlement_retry_total, dlq_total
- Traces: trade_id correlation

## Rollback / Recovery
- If settlement is broken, throttle/halt trading as per policy; replay from offsets after fix

## Dependencies
- B-0301
- B-0002
