name: CI

on:
  pull_request:
  push:
    branches: [main]

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: read
  security-events: write

jobs:
  changes:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      contracts: ${{ steps.filter.outputs.contracts }}
      rust: ${{ steps.filter.outputs.rust }}
      go: ${{ steps.filter.outputs.go }}
      kotlin: ${{ steps.filter.outputs.kotlin }}
      infra: ${{ steps.filter.outputs.infra }}
      ops: ${{ steps.filter.outputs.ops }}
    steps:
      - uses: actions/checkout@v4
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            contracts:
              - 'contracts/**'
              - 'buf.yaml'
              - 'buf.gen.yaml'
            rust:
              - 'services/trading-core/**'
              - 'Cargo.toml'
              - 'Cargo.lock'
            go:
              - 'services/edge-gateway/**'
              - 'go.mod'
              - 'go.sum'
            kotlin:
              - 'services/ledger-service/**'
              - 'streaming/flink-jobs/**'
              - 'settings.gradle.kts'
              - 'build.gradle.kts'
              - 'gradle/**'
              - 'gradlew'
              - 'gradlew.bat'
            infra:
              - 'infra/**'
            ops:
              - 'infra/**'
              - 'scripts/**'
              - 'runbooks/**'
              - 'changes/**'
              - 'controls/**'
              - 'assurance/**'
              - 'safety/**'
              - 'compliance/**'
              - 'policies/**'
              - 'specs/**'
              - 'tools/**'
              - 'security/**'
              - 'Makefile'
              - 'README.md'
              - 'RUNBOOK.md'
              - 'ARCHITECTURE.md'
              - 'API_SURFACE.md'

  contracts:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: changes
    if: needs.changes.outputs.contracts == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: bufbuild/buf-setup-action@v1
      - name: buf lint
        run: buf lint
      - name: buf generate
        run: buf generate
      - name: generated stubs up to date
        run: git diff --exit-code contracts/gen
      - name: buf breaking
        if: github.event_name == 'pull_request'
        run: |
          git fetch origin main --depth=1
          if git cat-file -e "origin/main:contracts/proto" 2>/dev/null; then
            buf breaking --against '.git#branch=main,subdir=contracts/proto'
          else
            echo "origin/main has no contracts/proto yet; skipping initial breaking check"
          fi
      - name: upload contracts report
        uses: actions/upload-artifact@v4
        with:
          name: contracts-report
          path: |
            buf.yaml
            buf.gen.yaml
            contracts/proto

  rust-test:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: changes
    if: needs.changes.outputs.rust == 'true' || needs.changes.outputs.contracts == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: cargo test
        run: |
          set -o pipefail
          cargo test 2>&1 | tee rust-test.log
      - name: upload rust report
        uses: actions/upload-artifact@v4
        with:
          name: rust-test-report
          path: rust-test.log

  go-test:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: changes
    if: needs.changes.outputs.go == 'true' || needs.changes.outputs.contracts == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24.x'
      - name: go test
        run: |
          set -o pipefail
          go test ./... -json 2>&1 | tee go-test.json
      - name: upload go report
        uses: actions/upload-artifact@v4
        with:
          name: go-test-report
          path: go-test.json

  gradle-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: changes
    if: needs.changes.outputs.kotlin == 'true' || needs.changes.outputs.contracts == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
      - uses: gradle/actions/setup-gradle@v3
      - name: gradle test
        run: ./gradlew test
      - name: upload gradle report
        uses: actions/upload-artifact@v4
        with:
          name: gradle-test-report
          path: |
            **/build/reports/tests/test
            **/build/test-results/test

  infra-validate:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: changes
    if: needs.changes.outputs.infra == 'true' || needs.changes.outputs.ops == 'true'
    steps:
      - uses: actions/checkout@v4
      - name: docker compose config
        run: docker compose -f infra/compose/docker-compose.yml config > /tmp/compose.rendered.yml
      - name: validate infra manifests
        run: ./scripts/validate_infra.sh
      - name: upload infra report
        uses: actions/upload-artifact@v4
        with:
          name: infra-compose-rendered
          path: /tmp/compose.rendered.yml

  load-smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: changes
    if: needs.changes.outputs.go == 'true' || needs.changes.outputs.kotlin == 'true' || needs.changes.outputs.ops == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24.x'
      - name: run load smoke
        run: ./scripts/load_smoke.sh
      - name: upload load smoke report
        uses: actions/upload-artifact@v4
        with:
          name: load-smoke-report
          path: build/load/load-smoke.json

  dr-rehearsal:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: changes
    if: needs.changes.outputs.go == 'true' || needs.changes.outputs.kotlin == 'true' || needs.changes.outputs.ops == 'true'
    steps:
      - uses: actions/checkout@v4
      - name: run DR rehearsal
        run: ./scripts/dr_rehearsal.sh
      - name: upload dr report
        uses: actions/upload-artifact@v4
        with:
          name: dr-rehearsal-report
          path: build/dr/dr-report.json

  exactly-once-stress:
    runs-on: ubuntu-latest
    timeout-minutes: 35
    needs: changes
    if: needs.changes.outputs.kotlin == 'true' || needs.changes.outputs.ops == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
      - name: run exactly-once stress
        run: |
          docker compose -f infra/compose/docker-compose.yml up -d postgres
          LEDGER_DB_NAME=exchange_ci_exactly_once
          docker compose -f infra/compose/docker-compose.yml exec -T postgres psql -U exchange -d postgres -c "DROP DATABASE IF EXISTS ${LEDGER_DB_NAME} WITH (FORCE);"
          docker compose -f infra/compose/docker-compose.yml exec -T postgres psql -U exchange -d postgres -c "CREATE DATABASE ${LEDGER_DB_NAME};"
          LEDGER_KAFKA_ENABLED=false \
          LEDGER_GUARD_ENABLED=false \
          LEDGER_RECONCILIATION_ENABLED=false \
          LEDGER_DB_URL="jdbc:postgresql://localhost:25432/${LEDGER_DB_NAME}" \
          LEDGER_DB_USER=exchange \
          LEDGER_DB_PASSWORD=exchange \
          LEDGER_PORT=18082 \
          ./gradlew :services:ledger-service:bootRun --quiet > /tmp/ledger-ci-exactly-once.log 2>&1 &
          LEDGER_PID=$!
          trap 'kill ${LEDGER_PID} >/dev/null 2>&1 || true' EXIT
          for _ in $(seq 1 90); do
            curl -fsS http://localhost:18082/readyz >/dev/null 2>&1 && break
            sleep 1
          done
          LEDGER_BASE_URL=http://localhost:18082 REPEATS=2000 CONCURRENCY=32 ./scripts/exactly_once_stress.sh
      - name: upload exactly-once logs
        uses: actions/upload-artifact@v4
        with:
          name: exactly-once-stress-report
          path: |
            /tmp/ledger-ci-exactly-once.log

  chaos-replay:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    needs: changes
    if: needs.changes.outputs.go == 'true' || needs.changes.outputs.kotlin == 'true' || needs.changes.outputs.rust == 'true' || needs.changes.outputs.ops == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24.x'
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
      - uses: dtolnay/rust-toolchain@stable
      - name: run full chaos replay
        run: ./scripts/chaos/full_replay.sh
      - name: run redpanda bounce drill
        run: ./scripts/chaos/redpanda_broker_bounce.sh
      - name: upload chaos logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: chaos-replay-report
          path: |
            /tmp/trading-core-chaos-replay.log
            /tmp/edge-gateway-chaos-replay.log
            /tmp/ledger-service-chaos-replay.log
            /tmp/chaos-replay-trades-*.jsonl

  safety-case:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    needs: [changes, load-smoke, dr-rehearsal, exactly-once-stress, chaos-replay, security-baseline]
    if: needs.changes.outputs.ops == 'true' || needs.changes.outputs.go == 'true' || needs.changes.outputs.kotlin == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24.x'
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
      - uses: dtolnay/rust-toolchain@stable
      - name: generate safety case
        run: ./scripts/safety_case.sh --run-checks
      - name: upload safety case bundle
        uses: actions/upload-artifact@v4
        with:
          name: safety-case-bundle
          path: |
            build/safety-case/**/*.json
            build/safety-case/*.tar.gz
            build/safety-case/*.sha256
            build/safety-case/**/reports

  verification-factory-lite:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: changes
    if: needs.changes.outputs.ops == 'true'
    steps:
      - uses: actions/checkout@v4
      - name: seed minimal evidence for verification factory
        run: |
          mkdir -p build/load build/dr build/invariants
          cat > build/load/load-smoke.json <<'JSON'
          {
            "order_p99_ms": 10.0,
            "order_error_rate": 0.0,
            "thresholds_passed": true
          }
          JSON
          cat > build/dr/dr-report.json <<'JSON'
          {
            "restore_time_ms": 1000,
            "replay_time_ms": 500,
            "invariant_violations": 0
          }
          JSON
          cat > build/invariants/ledger-invariants.json <<'JSON'
          {
            "ok": true
          }
          JSON
      - name: run verification factory
        run: ./scripts/verification_factory.sh
      - name: run release gate
        run: ./scripts/release_gate.sh
      - name: upload verification factory artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: verification-factory-lite
          path: |
            build/verification/**
            build/safety-case/**
            build/controls/**
            build/compliance/**
            build/transparency/**
            build/safety/**
            build/assurance/**
            build/external-replay/**
            build/release-gate/**
            build/archive/**
            build/access/**
            build/model-check/**
            build/shadow/**

  security-baseline:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - name: trivy (secret scan)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: fs
          scanners: secret
          format: sarif
          output: trivy-secrets.sarif
          severity: HIGH,CRITICAL
          exit-code: '1'
      - name: secret rotation drill
        run: ./scripts/secret_rotation_drill.sh
      - name: trivy (dependency and fs vulnerability scan)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: fs
          scanners: vuln
          format: sarif
          output: trivy-results.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          exit-code: '1'
      - name: upload SARIF (secrets)
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-secrets.sarif
      - name: upload SARIF (vulns)
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-results.sarif
      - name: upload security report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: |
            trivy-results.sarif
            trivy-secrets.sarif
